--- 
# ansible playbook to bootstrap silverstone home server from a default proxmox install

- name: 'bootstrap silverstone'
  hosts: silverstone
  remote_user: connor
  vars_files:
    - host_vars/silverstone/packages.yml
    - host_vars/silverstone/secret.yml

  pre_tasks: # pre_tasks will run before the roles. important because roles depend on packages and hostname

  - name: Update packages
    become: true
    apt:
      update_cache: yes
      upgrade: full
      autoremove: true

  - name: create 'connor' user
    become: true
    ansible.builtin.user:
      name: connor
      password: "{{ silverstone_user_password }}"
      shell: /bin/bash
      groups: sudo # add new groups like group1,group2,etc
      append: true

  - name: install packages
    become: true
    package:
      name: "{{ install_packages }}"
      state: latest

  roles:

    - role: geerlingguy.docker
      become: true
      vars:
        # these options ensure you can use `docker compose`
        docker_install_compose_plugin: true
        docker_compose_package: docker-compose-plugin
        docker_compose_package_state: present
        docker_users:
          - connor # handles adding connor to the docker group
        # note: must use `su - connor` or reboot to have access to docker without sudo

    - role: ironicbadger.proxmox_nag_removal
      become: true

   #- role: danielrolls.nix
   #  become: true

  post_tasks:

  - name: install nix packages
    shell: |
      /nix/var/nix/profiles/default/bin/nix-env -iA \
        nixpkgs.rclone \
        nixpkgs.distrobox \
        nixpkgs.lf \
        nixpkgs.lazydocker \
        nixpkgs.gotop
    args:
      executable: /bin/bash


  - name: Reboot server
    become: true
    ansible.builtin.command: reboot
    ignore_errors: true
